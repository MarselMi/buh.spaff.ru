{% extends 'mainapp/base.html' %}
{% load static %}
{% block content %}

	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div>
						<form method="POST" action="">
							{% csrf_token %}

							<div class="row">

								<div class="col-12 col-sm-3 mb-3">
									<label for="holder_type">Тип балансодержателя</label>
									<select autocomplete="off" class="obligatory form-select" name="holder_type" id="holder_type">
										<option selected value="{{ holder.holder_type }}">{{ holder.holder_type|translate_type_balance_holder }}</option>
										{% if holder.holder_type == "PRIVATE_PERSONE" %}
											<option value="ORGANISATION">Организация</option>
										{% else %}
											<option value="PRIVATE_PERSONE">Частное лицо</option>
										{% endif %}
									</select>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									<label id="label_organisation" for="organization_holder">
										{% if holder.holder_type == "PRIVATE_PERSONE" %}
										ФИО держателя
										{% else %}
										Наименование организации
										{% endif %}
									</label>
									<input autocomplete="off" class="obligatory form-control" name="organization_holder" id="organization_holder" value="{{ holder.organization_holder }}"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									<label for="account_type">Привязка номера карты/счета к балансодержателю</label>
									<select autocomplete="off" class="obligatory form-select" name="account_type" id="account_type">
										{% for i, k in type_account.items %}
											{% if i == holder.account_type %}
											<option selected value="{{ i }}">{{ k }}</option>
											{% else %}
											<option value="{{ i }}">{{ k }}</option>
											{% endif %}
										{% endfor %}
									</select>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									<label id="label_payment_account" for="payment_account">
										{% if holder.account_type == 'SCORE' %}
											Расчетный счет
										{% elif holder.account_type == 'CARD' %} 
											Номер карты
										{% else %}
											Введите любую информацию
										{% endif %}
									</label>
									{% if holder.account_type == 'SCORE' or holder.account_type == 'CARD' %}
										<input autocomplete="off" class="obligatory form-control" name="payment_account" id="payment_account" value="{{ holder.payment_account|for_card_step }}"/>
									{% else %}
									<input autocomplete="off" class="obligatory form-control" name="payment_account" id="payment_account" value="{{ holder.payment_account }}"/>
									{% endif %}
								</div>

								<div class="col-12 col-sm-3 mb-3">
									<label for="alias_holder">Псевдоним реквизита</label>
									<input autocomplete="off" class="obligatory form-control" name="alias_holder" id="alias_holder" value="{{ holder.alias_holder }}"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									
									<span data-bs-toggle="tooltip" data-bs-title="Для выбора нескольких зажмите Ctrl">
										<label for="current">Выберите курсы валют:</label>
									</span>
									<select class="form-select" aria-label="multiple select example" name="current" id="current" multiple>
										{% for i in all_currents_dict %}
											{% if i.id in selected_list %}
												<option selected value="{{ i.id }}">{{ i.current_name }}</option>
											{% else %}
												<option value="{{ i.id }}">{{ i.current_name }}</option>
											{% endif %}
										{% endfor %}
									</select>

								</div>

								{% if user.is_superuser %}

									<div class="col-12 col-sm-3 mb-3">
										<label for="hide_holder">Скрыть балансодержателя</label><br>
										<input class="form-check-input" type="checkbox" name="hide_holder" id="hide_holder"
											   {% if holder.hidden_status %} checked{% else %}{% endif %}/>
									</div>

									<div class="superusers_list col-12 col-sm-3 mb-3" {% if holder.hidden_status %}{% else %} hidden {% endif %}>
										<span data-bs-toggle="tooltip" data-bs-title="Для выбора нескольких зажмите Ctrl">
											<label for="superuser_available">Открыть доступ для:</label>
										</span>
										<select class="form-select" aria-label="multiple select example" name="superuser_available" id="superuser_available" multiple>
											{% for user_select in users %}
												{% if user_select.id != request.user.id %}
													{% if user_select in holder.available_superuser.all %}
														<option selected value="{{ user_select.id }}">{{ user_select.username }}</option>
													{% else %}
														<option value="{{ user_select.id }}">{{ user_select.username }}</option>
													{% endif %}
												{% endif %}
											{% endfor %}
										</select>
									</div>

								{% endif %}

								<div class="col-12 col-sm-3 mb-3">
									<label class="flex-inline" for="color">
										Отображение цвета
										<span id="color_example" {% if holder.color %} style="background: {{ holder.color }}"{% else %} style="background: lightblue;" {% endif %}>
											{пример}
										</span>
									</label>
									<select autocomplete="off" class="form-select" name="color" id="color">
										{% for value, item in color_dict.items %}
											{% if value == holder.color %}
												<option selected value="{{ value }}">{{ item }}</option>
											{% else %}
												<option value="{{ value }}">{{ item }}</option>
											{% endif %}
										{% endfor %}
									</select>
								</div>

							</div>

							<div class="row">

								<button class="btn btn-primary create_holder" type="submit">
									Сохранить
								</button> <!-- /btn -->

							</div>
						</form>
					</div> <!-- /table-responsive -->
				</div> <!-- /card-body -->
			</div> <!-- /card -->
		</div> <!-- /col -->
	</div> <!--/row-->
	
<script type="text/javascript">

	var url = document.location.href;
	var a = document.cookie.split(';');
	var token = '';

	for (i = 0; i < a.length; i++) {
		var b = a[i].split('=');
		b[0] = b[0].replace(/\s+/g, '');
		if (b[0] == 'csrftoken') {
			token = b[1];
		}
	};

	var regEx = /[\\><\|\/a-zA-Z\/\+~\=`\]!\[@\{#\}$%\^&:;*\?\(\)_\-а-яА-Я]/;

	$('#hide_holder').on('change', function(){
		if($('#hide_holder').is(':checked')){
			$('.superusers_list').removeAttr('hidden');
		}else{
			$('.superusers_list').attr('hidden', 'true');
			$('#superuser_available').val('');
		}
	})

	$('#color').on('change', function(){
		$('#color_example').attr('style', `background: ${$('#color').val()}`);
	});

	

	$('#payment_account').on('input change', function(){
		var paccount = $('#payment_account').val().replace(/\s+/g, '');
		if ($('#account_type').val() == "CARD" || $('#account_type').val() == "SCORE"){
			if (paccount){
				if (regEx.test(paccount) || ((paccount.length > 20)) || ((paccount.length < 16))){
					$('#payment_account').addClass('is-invalid');
					$('#payment_account').removeClass('is-valid');
				}else{
					$('#payment_account').removeClass('is-invalid');
					$('#payment_account').addClass('is-valid');
				}
			}
		}else{
			$('#payment_account').removeClass('is-valid');
		}	
	})

	$('#organization_holder').on('input', function(){
		$(".error").remove();
		$.ajax(
			{
				url: url,
				method: 'POST',
				data: {
					csrfmiddlewaretoken: token,
					type: 'check_holder',
					organization_holder: $('#organization_holder').val()
				}
			}).then(function(result) {
				if (result.message) {
					$('#organization_holder').removeClass('is-invalid');
					$('#organization_holder').addClass('is-valid');
				} else {
					$('#organization_holder').removeClass('is-valid');
					$('#organization_holder').addClass('is-invalid');
					$('#organization_holder').after('<div class="invalid-feedback error">Такой балансодержатель уже зарегестрирован</div>')
				}
				if (!$('#organization_holder').val()){
					$('#organization_holder').removeClass('is-valid');
					$('#organization_holder').addClass('is-invalid');
				}
			}).catch(function(err) {
				var x = 1;
			}
		)
	})

	$('#holder_type').on('change', function(){
		if($('#holder_type').val()){
			$('#holder_type').removeClass('is-invalid')
			if ($('#holder_type').val() == "PRIVATE_PERSONE"){
				$('#label_organisation').text('ФИО держателя')
				$('#organization_holder').attr('placeholder', 'Иванов Иван Иванович')
			}else if ($('#holder_type').val() == "ORGANISATION"){
				$('#label_organisation').text('Наименование организации')
				$('#organization_holder').attr('placeholder', 'OOO "IT"')
			}
		}else{
			$('#holder_type').addClass('is-invalid')
		}
	})

	$('#account_type').on('change', function(){
		if($('#account_type').val()){
			if ($('#account_type').val() == "CARD"){
				$('#payment_account').val('');
				$('#label_payment_account').text('Номер карты')
				$('#payment_account').attr('placeholder', '**** **** **** ****')
			}else if ($('#account_type').val() == "SCORE"){
				$('#payment_account').val('');
				$('#label_payment_account').text('Номер расчетного счета')
				$('#payment_account').attr('placeholder', '**** **** **** **** ****')
			}else{
				$('#payment_account').val('');
				$('#label_payment_account').text('Введите любую информацию')
				$('#payment_account').attr('placeholder', 'Наличные')
				$('#payment_account').removeClass('is-invalid');
			}
		}
	})

	$('form').on('change keyup input click focusot live', function(){

		if ($('#organization_holder').hasClass('is-invalid')){
			$('.create_holder').attr('disabled', 'true');
		}else if ($('#payment_account').hasClass('is-invalid')){
			$('.create_holder').attr('disabled', 'true');
		}else if ($('#alias_holder').hasClass('is-invalid')){
			$('.create_holder').attr('disabled', 'true');
		}else{
			$('.create_holder').removeAttr('disabled');
		}
	})

	$(document).ready(function() {
		$('form').submit(function(e) {
			e.preventDefault();
			var valid = true;

			var payment_account = $('#payment_account').val().replace(/\s+/g, '');
			var validPayment_account = regEx.test(payment_account);

			$(".error").remove();
			if ($('#account_type').val() == "CARD" || $('#account_type').val() == "SCORE"){
				if (validPayment_account || ((payment_account.length > 20)) || ((payment_account.length < 16))){
					$('#payment_account').addClass('is-invalid');
					$('#payment_account').after('<span class="error">Введите корректные данные</span>');
					valid = false;
				}
			}else{
				valid = true;
			}
			if (valid) this.submit();
		});
	});

</script>

{% endblock content %}
