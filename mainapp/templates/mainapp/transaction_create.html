{% extends 'mainapp/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}

	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="card-body">
						<form method="POST"  action="" enctype="multipart/form-data">
							{% csrf_token %}

							<div class="row">

								<div class="col-12 col-sm-3 mb-3">
									{{ form.balance_holder.label }}
									<input class="form-control is-invalid" name="balance_holder" id="balance_holder" autocomplete="off" onfocus="this.value=''" list="balance_holder_list" placeholder="Выберите балансодержателя"/>
									<datalist id="balance_holder_list">
										{% for holder in balance_holders %}
										<option value="{{ holder }}">{{ holder }}</option>
										{% endfor %}
									</datalist>
								</div>

								<div class="col-12 col-sm-3 mb-3">
								  {{ form.name.label }}
								  	<input class="obligatory form-control mb-2 is-invalid" autocomplete="off" onfocus="this.value=''" name="transaction_name" id="transaction_name" placeholder="Имя транзакции"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									{{ form.transaction_date.label }}
									<input class="obligatory form-control is-invalid" autocomplete="off" name="transaction_date" placeholder="Нажмите сюда" id="datepicker"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									{{ form.type_payment.label }}
									<input class="form-control is-invalid" autocomplete="off" onfocus="this.value=''" list="list_pay" name="type_payment" id="type_payment" placeholder="Тип платежа"/>
									<datalist id="list_pay">
										{% for type in type_payments %}
										<option value="{{ type }}">{{ type }}</option>
										{% endfor %}
									</datalist>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									{{ form.amount.label }}
									<input class="obligatory form-control is-invalid" autocomplete="off" name="amount" placeholder="Сумма транзакции" id="amount"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
								  {{ form.type_transaction.label }}
									<input class="form-control mb-2 is-invalid" autocomplete="off" onfocus="this.value=''" name="type_transaction" list="datalist_transaction_type" id="type_transaction" placeholder="Тип транзакции"/>
								  	<datalist id="datalist_transaction_type">
										<option value="Приход">Приход</option>
										<option value="Расход">Расход</option>
									</datalist>
								</div>

							</div>

							<div id="accordionStatsDaysFilter">
								<div id="collapseStatsDaysFilter-1" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionStatsDaysFilter" style="">
									<div class="row">

										<div class="col-12 col-sm-3 mb-3">
										  {{ form.status.label }}
											<select class="obligatory form-select mb-2" name="transaction_status" id="transaction_status">
												<option value="В процессе">В процессе</option>
												<option value="Отклонен">Отклонен</option>
												<option selected value="Успешно">Успешно</option>
											</select>
										</div>

										<div class="col-12 col-sm-3 mb-3">
											{{ form.check_img.label }}
											<input class="form-control mb-2 fileinput fileUpload form-control-file" name="check_img" type="file" id="id_check_img">
										</div>

										<div class="col-12 col-sm-3 mb-3">
											{{ form.description.label }}
											{{ form.description }}
										</div>

										<div class="col-12 col-sm-3 mb-3">
											{{ form.tags.label }}
											{{ form.tags }}
										</div>

									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-sm-3 mb-3">

									<button class="btn btn-primary save_button" type="submit" disabled>
										Сохранить
									</button> <!-- /btn -->

									<button onclick="$(this).text($(this).text() == 'Скрыть' ? 'Раскрыть' : 'Скрыть');" type="button" class="btn btn-secondary text-white collapsed" data-bs-toggle="collapse" data-bs-target="#collapseStatsDaysFilter-1" aria-expanded="false" aria-controls="collapseStatsDaysFilter-1">
										Раскрыть
									</button>

								</div>
							</div>

						</form> <!-- /form-body -->
					</div> <!-- /card-body -->
				</div> <!-- /card-body -->
			</div> <!-- /card -->
		</div> <!-- /col -->
	</div> <!--/row-->

<script type="text/javascript">
	$(function(){
		$("#datepicker").datepicker({dateFormat: 'dd.mm.yy'});
	});
</script>

<script type="text/javascript">

	var url = document.location.href;
	var a = document.cookie.split(';');
	var token = ''

	for (i = 0; i < a.length; i++) {
		var b = a[i].split('=')
		b[0] = b[0].replace(/\s+/g, '')
		if (b[0] == 'csrftoken') {
		token = b[1]
		}
	}

	var regEx = /[\\><\|\/a-zA-Z\/\+~\=`\]!\[@\{#\}$%\^&:;*\?\(\)_\-а-яА-Я]/;

	$('#balance_holder').on('input', function(){
		$('.error_holder').remove();
		$.ajax(
			{
				url: url,
				method: 'POST',
				data: {
					csrfmiddlewaretoken: token,
					type: 'check_holder',
					balance_holder: $('#balance_holder').val()
				}
			}).then(function(result) {
				if (result.message) {
					$('#balance_holder').removeClass('is-invalid');
					$('#balance_holder').addClass('is-valid');
				} else {
					$('#balance_holder').removeClass('is-valid');
					$('#balance_holder').addClass('is-invalid');
					$('#balance_holder').after('<div class="invalid-feedback error_holder">Такого балансодержателя нет</div>')
				}
			}).catch(function(err) {
				var x = 1;
			}
		)
	})

	$('#type_payment').on('input', function(){
		$('.error_type').remove();
		$.ajax(
			{
				url: url,
				method: 'POST',
				data: {
					csrfmiddlewaretoken: token,
					type: 'check_type',
					type_payment: $('#type_payment').val()
				}
			}).then(function(result) {
				if (result.message) {
					$('#type_payment').removeClass('is-invalid');
					$('#type_payment').addClass('is-valid');
				} else {
					$('#type_payment').removeClass('is-valid');
					$('#type_payment').addClass('is-invalid');
					$('#type_payment').after('<div class="invalid-feedback error_type">Нет такого типа платежа</div>')
				}
			}).catch(function(err) {
				var x = 1;
			}
		)
	})

	$('form').on('change keyup input click focusot live', function(){
		var type_val = $('#type_transaction').val()

		if (type_val){
			if ((type_val == 'Приход') || (type_val == 'Расход')){
				$('#type_transaction').removeClass('is-invalid');
			}else{
				$('#type_transaction').addClass('is-invalid');
			}
		}else{
			$('#type_transaction').addClass('is-invalid');
		}
		
		$('.error').remove();
		var objects = $('.obligatory')

		for (let i=0; objects.length > i; i++){
			if (objects[i].value){
				objects[i].classList.remove('is-invalid')
			}else{
				objects[i].classList.add('is-invalid')
			}
		}

		if ($('#amount').val() && (!regEx.test($('#amount').val()))){
			$('#amount').removeClass('is-invalid');
		}else{
			$('#amount').addClass('is-invalid');
			$('#amount').after('<div class="invalid-feedback error">Введите корректные данные</div>')
		}

		if ($('#balance_holder').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else if ($('#transaction_name').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else if ($('#transaction_status').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else if ($('#datepicker').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else if ($('#type_payment').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else if ($('#amount').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else if ($('#type_transaction').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else if ($('#id_check_img').hasClass('is-invalid')){
			$('.save_button').attr('disabled', 'true');
		}else{
			$('.save_button').removeAttr('disabled');
		}
	})

	$('#datepicker').on('change click focusot hover', function(){
		if ($('#datepicker').val()){
			$('#datepicker').removeClass('is-invalid')
		}else{
			$('#datepicker').addClass('is-invalid')
		}
	})

</script>

{% endblock content %}