{% extends 'mainapp/base.html' %}
{% load static %}
{% block content %}

	<div class="row">
		<div class="col-12">
			<div class="card mb-4">
				<div class="card-body">
					<div id="accordion">
						<div id="collapse-1" class="row accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordion">

							<form action="" method="POST" type="add_pdr">
								{% csrf_token %}
								<div class="row">
									<div class="col-12 col-sm-3 mb-3">

										<label for="balance_holder">Для балансодержателя</label>
										<input class="form-control" autocomplete="off" id="balance_holder" list="balance_holder_list" placeholder="OOO &quot;СПАФФ ИТ&quot;"/>
										<datalist id="balance_holder_list">
											{% for holder in balance_holders %}
											<option value="{{ holder.organization_holder }}">{{ holder.organization_holder }}</option>
											{% endfor %}
										</datalist>

									</div>

									<div class="col-12 col-sm-3 mb-3">
										<label class="label" for="month">Месяц</label>
										<select class="form-select" name="month" id="month">
											{% for key, val in month_dict.items %}
												<option value="{{ key }}">{{ val }}</option>
											{% endfor %}
										</select>
									</div>

									<div class="col-12 col-sm-3 mb-3">
										<label class="label" for="year">Год</label>
										<select class="form-select" name="year" id="year">
											{% for i in year_list %}
											<option value="{{ i }}">{{ i }}</option>
											{% endfor %}
										</select>	
									</div>
								</div>

								<div class="border-top mt-1 add_new_bdr" hidden></div>

								<div class="row add_new_bdr" hidden>
									
									<div class="col-12 col-sm-3">
										
										<div class="card-header d-flex align-items-center card-header-no-bg">
											<div class="card-title h6 fw-bold text-uppercase border-start border-primary border-3 ps-2">
												Предполагаемые затраты
											</div>
										</div>

									</div>
									<div class="col-12 col-sm-3 mb-1 additional_params" hidden>
										
										<label for="category_id">Добавить поле категории/подкатегории</label>
										<select class="form-select" id="category_id">
											
											{% for type in type_pay_for_final %}
												{% if type.type_id %}
												<option value="pay_type&{{ type.type_id }}&{{ type.pay_type }}">{{ type.pay_type }}</option>
												{% else %}
												<option value="pay_sub_type&{{ type.sub_id }}&{{ type.sub_type }}">{{ type.sub_type }}</option>
												{% endif %}
											{% endfor %}

										</select>

									</div>

									<div class="col-12 col-sm-3 mb-1 mt-4 additional_params" hidden>

										<a class="btn btn-primary add_category">
											Добавить
										</a>

									</div>
								</div>	
								
								<div class="card-body add_new_bdr" hidden>
									<div class="row">
										
										<input id="bal_hol_post" name="balance_holder" hidden/>

										<div class="border-top mt-1 mb-4"></div>

										<div class="row category_list">

										</div>	

									</div>

								</div>

								<div class="border-top mt-1 mb-4 add_new_bdr" hidden></div>

								<div class="row add_new_bdr" hidden>
									
									<div class="col-12 col-sm-3 mb-3">
										<div class="card-header d-flex align-items-center card-header-no-bg ">
											<div class="card-title h6 fw-bold text-uppercase border-start border-primary border-3 ps-2 mb-3">
												Предполагаемый доход
											</div>
										</div>
									</div>

									<div class="col-12 col-sm-3 mb-3 profit_params" hidden>
									
										<label for="category_profit_id">Добавить поле категории/подкатегории</label>
										<select class="form-select" id="category_profit_id">
											
											{% for type in type_pay_for_final %}
												{% if type.type_id %}
												<option value="pay_type&{{ type.type_id }}&{{ type.pay_type }}">{{ type.pay_type }}</option>
												{% else %}
												<option value="pay_sub_type&{{ type.sub_id }}&{{ type.sub_type }}">{{ type.sub_type }}</option>
												{% endif %}
											{% endfor %}
		
										</select>
		
									</div>
		
									<div class="col-12 col-sm-3 mb-1 mt-4 profit_params" hidden>
		
										<a class="btn btn-primary add_profit_category">
											Добавить
										</a>
		
									</div>

								</div>

								<div class="border-top mt-1 mb-4 add_new_bdr" hidden></div>

								<div class="card-body add_new_bdr" hidden>

									<div class="row profit_params_row">

									</div>

									<div class="border-top mt-1 mb-4"></div>
									
									<div class="row">
										<div class="col-sm-3">
											<button class="btn btn-primary save_button" type="submit">
												Создать
											</button>
										</div>
									</div>
									
								</div>
								<div class="border-top mt-1 mb-4 add_new_bdr" hidden></div>
							</form>	
						</div>
					</div>

					<button onclick="$(this).text($(this).text() == 'Добавить' ? 'Скрыть' : 'Добавить');" type="button" class="mb-1 btn btn-secondary text-white collapsed" data-bs-toggle="collapse" data-bs-target="#collapse-1" aria-expanded="false" aria-controls="collapse-1">Добавить</button>

					<div class="card-header d-flex align-items-center card-header-no-bg">

						<div class="card-title h6 fw-bold text-uppercase border-start border-primary border-3 ps-2 mt-3" {% if bdr_fond_information %}{% else %} hidden {% endif %}>
							Выбрать балансодержателя и период для просмотра данных
						</div>

					</div>

					<form method="POST">
						{% csrf_token %}
						<div class="row" {% if bdr_fond_information %}{% else %} hidden {% endif %}>

							<div class="col-12 col-sm-3 mb-3">
								<label for="balance_holder_req">Балансодержатель</label>
								<select class="form-select" name="balance_holder_req" id="balance_holder_req">

									<option selected value="">Выберите</option>
									{% for holder in bdr_fond_information %}
									<option value="{{ holder.bal_hol }}">{{ holder.bal_hol }}</option>
									{% endfor %}

								</select>

							</div>

							<div class="col-12 col-sm-3 mb-3 period_req_div_el" hidden>
								<label class="label" for="start_bdr">Старт</label>
								<select class="form-select date_select" name="start_bdr" id="start_bdr">

								</select>
							</div>

							<div class="col-12 col-sm-3 mb-3 period_req_div_el" hidden>
								<label class="label" for="end_bdr">Конец</label>
								<select class="form-select date_select" name="end_bdr" id="end_bdr">

								</select>
							</div>

							<div class="">
								<a class="btn btn-primary show_pdr">
									Посмотреть
								</a>
							</div>

						</div>
					</form>	

					<div class="table-responsive mt-4 table_for_bdr" hidden>
						<div class="mb-3">
							Данные по: <span id="information_tabel" class="h6 fw-bold text-uppercase"></span>
						</div>
						<table class="text-center table table-bordered text-nowrap mb-0 table-hover">
							<thead>
								<tr>
									<th>Категория</th>
									<th>Предполагаемый (руб)</th>
									<th>Фактический (руб)</th>
									<th>Отклонения (руб)</th>
									<th>Отклонения (%)</th>
								</tr>
							</thead>
							<tbody class="information_result">

							</tbody>
						</table> <!-- /table -->
					</div>

				</div> <!-- /card-body -->
			</div> <!-- /card -->
		</div> <!-- /col -->
	</div> <!-- /row -->

	<script type="text/javascript">

		var url = document.location.href;
		var a = document.cookie.split(';');
		var token = '';

		for (i = 0; i < a.length; i++) {
			var b = a[i].split('=');
			b[0] = b[0].replace(/\s+/g, '');
			if (b[0] == 'csrftoken') {
				token = b[1];
			}
		};

		// $(function(){
		// 	$("#start_pdr").datepicker({
		// 		changeMonth: true,
		// 		dateFormat: 'mm-yy',
		// 		maxDate: '0'})
		// });

		// $(function(){
		// 	$("#end_pdr").datepicker({
		// 		changeMonth: true,
		// 		dateFormat: 'mm-yy',
		// 		maxDate: '0'})
		// });

		$('#balance_holder').on('input', function(){
			if($('#balance_holder').val()){
				$('#bal_hol_post').val($('#balance_holder').val())
				$.ajax(
				{
					url: url,
					method: 'POST',
					data: {
						csrfmiddlewaretoken: token,
						type: 'balance_holder',
						bal_holder: $('#balance_holder').val()
					}
				}).then(function(result){
					$('.add_new_bdr').removeAttr('hidden');
					$('.category_list').empty();
					$('.profit_params_row').empty();
					if (result.date_month){
						$('#month').val(result.date_month);
					}else{
						$('#month').val('01-01');
					};
					$('#year').val(result.date_year);
					if(result.bal_holder.length){
						$('.additional_params').attr('hidden', 'true');
						$('.profit_params').attr('hidden', 'true');
						var list_el = result.bal_holder;
						for (let i=0; list_el.length > i; i++){
							var new_category = `<div class="col-12 col-sm-3 mb-3 input_elems">
										<label class="label" for="${list_el[i][1].html_el_id}">${list_el[i][1].label}</label>
										<input class="form-control" autocomplete="off" name="${list_el[i][0]}" id="${list_el[i][1].html_el_id}" placeholder="${list_el[i][1].value}"/>
									</div>`;
							if(list_el[i][1].type == 'expend'){
								$('.category_list').append(new_category);
							}else if (list_el[i][1].type == 'profit'){
								$('.profit_params_row').append(new_category);
							}
						}
					}else{
						$('.additional_params').removeAttr('hidden');
						$('.profit_params').removeAttr('hidden');
						$('.input_elems').remove();
					}
				}).catch(function(err){
					var x = 0;
				})
			}
		})

		$('.add_category').on('click', function(){
			if($('#category_id').val()){
				var inputEls = $('#category_id').val().split('&')
				var new_category = `<div class="col-12 col-sm-3 mb-3">
										<label class="label" for="${inputEls[0]}_${inputEls[1]}_expend">${inputEls[2]}</label>
										<input class="form-control" autocomplete="off" name="${inputEls[0]}&${inputEls[1]}&${inputEls[2]}&expend" id="${inputEls[0]}_${inputEls[1]}_expend" placeholder="3000"/>
									</div>`
				if(!$('.category_list').find($(`#${inputEls[0]}_${inputEls[1]}_expend`)).length){
					$('.category_list').append(new_category)
				}
			}
		})

		$('.add_profit_category').on('click', function(){
			if($('#category_profit_id').val()){
				var inputEls = $('#category_profit_id').val().split('&')
				var new_category = `<div class="col-12 col-sm-3 mb-3">
										<label class="label" for="${inputEls[0]}_${inputEls[1]}_profit">${inputEls[2]}</label>
										<input class="form-control" autocomplete="off" name="${inputEls[0]}&${inputEls[1]}&${inputEls[2]}&profit" id="${inputEls[0]}_${inputEls[1]}_profit" placeholder="3000"/>
									</div>`
				if(!$('.profit_params_row').find($(`#${inputEls[0]}_${inputEls[1]}_profit`)).length){
					$('.profit_params_row').append(new_category)
				}
			}
		})

		$('#balance_holder_req').on('change', function(){
			if($('#balance_holder_req').val()){
				$.ajax(
				{
					url: url,
					method: 'POST',
					data: {
						csrfmiddlewaretoken: token,
						type: 'bal_hol_req_sql',
						bal_holder: $('#balance_holder_req').val()
					}
				}).then(function(result){
					$('.period_req_div_el').removeAttr('hidden');
					document.getElementById('start_bdr').innerHTML = '';
					document.getElementById('end_bdr').innerHTML = '';
					var dateEl = result.allow_date
					for(let i = 0; dateEl.length > i; i++){
						var option_element = `<option value="${dateEl[i].month_year}">${dateEl[i].month_year}</option>`
						$('.date_select').append(option_element)
					}
				}).catch(function(err){
					var x = 0;
				});
			}
		})

		var priceSet;

		priceSet = function(data){
			var price       = Number.prototype.toFixed.call(parseFloat(data) || 0, 2),
				price_sep   = price.replace(/(\D)/g, ","),
				price_sep   = price_sep.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1 ");
			if(price_sep[0] == ','){
				price_sep = price_sep.substring(1);
				price_sep = '-' + price_sep;
				return price_sep;
			}else{
				return price_sep;
		}
		};

		$('.show_pdr').on('click', function(){
			$.ajax(
			{
				url: url,
				method: 'POST',
				data: {
					csrfmiddlewaretoken: token,
					type: 'show_bdr',
					balance_holder_req: $('#balance_holder_req').val(),
					start_bdr: $('#start_bdr').val(),
					end_bdr: $('#end_bdr').val()
				}
			}).then(function(result){
				$('.table_for_bdr').removeAttr('hidden');
				var bh = $('#balance_holder_req').val();
				var start_ = $('#start_bdr').val();
				var end_ = $('#end_bdr').val();
				$('#information_tabel').text(`${bh}, ${start_}  :  ${end_}`);
				var res = result.res;
				$('.information_result').empty();
				for (var key in res){
					if(key == 'расход'){
						for(var values in res[key]){
							if (values != 'final'){
								if(res[key][values].plan > res[key][values].fact){
									var trElement = `
									<tr>
										<td>${values}</td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].fact)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].raznica)}</td>
										<td style="background: lightblue">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else if(res[key][values].plan < res[key][values].fact){
									var trElement = `
									<tr>
										<td>${values}</td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: pink">${priceSet(res[key][values].fact)}</td>
										<td style="background: pink">${priceSet(res[key][values].raznica)}</td>
										<td style="background: pink">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else{
									var trElement = `
									<tr>
										<td>${values}</td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td>${priceSet(res[key][values].fact)}</td>
										<td>${priceSet(res[key][values].raznica)}</td>
										<td>${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}
							}else if(values == 'final'){
								if(res[key][values].plan > res[key][values].fact){
									var trElement = `
									<tr class="table-light">
										<td><span class="h6 fw-bold text-uppercase">Итого Расходов</span></td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].fact)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].raznica)}</td>
										<td style="background: lightblue">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else if(res[key][values].plan < res[key][values].fact){
									var trElement = `
									<tr class="table-light">
										<td><span class="h6 fw-bold text-uppercase">Итого Расходов</span></td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: pink">${priceSet(res[key][values].fact)}</td>
										<td style="background: pink">${priceSet(res[key][values].raznica)}</td>
										<td style="background: pink">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else{
									var trElement = `
									<tr class="table-light">
										<td><span class="h6 fw-bold text-uppercase">Итого Расходов</span></td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td>${priceSet(res[key][values].fact)}</td>
										<td>${priceSet(res[key][values].raznica)}</td>
										<td>${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}
							}
						}
					}else if (key == 'доход'){
						for(var values in res[key]){
							if (values != 'final'){
								if(res[key][values].plan < res[key][values].fact){
									var trElement = `
									<tr>
										<td>${values}</td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].fact)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].raznica)}</td>
										<td style="background: lightblue">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else if(res[key][values].plan > res[key][values].fact){
									var trElement = `
									<tr>
										<td>${values}</td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: pink">${priceSet(res[key][values].fact)}</td>
										<td style="background: pink">${priceSet(res[key][values].raznica)}</td>
										<td style="background: pink">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else{
									var trElement = `
									<tr>
										<td>${values}</td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td>${priceSet(res[key][values].fact)}</td>
										<td>${priceSet(res[key][values].raznica)}</td>
										<td>${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}
							}else if(values == 'final'){
								if(res[key][values].plan < res[key][values].fact){
									var trElement = `
									<tr class="table-light">
										<td><span class="h6 fw-bold text-uppercase">Итого Доходов</span></td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].fact)}</td>
										<td style="background: lightblue">${priceSet(res[key][values].raznica)}</td>
										<td style="background: lightblue">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else if(res[key][values].plan > res[key][values].fact){
									var trElement = `
									<tr class="table-light">
										<td><span class="h6 fw-bold text-uppercase">Итого Доходов</span></td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td style="background: pink">${priceSet(res[key][values].fact)}</td>
										<td style="background: pink">${priceSet(res[key][values].raznica)}</td>
										<td style="background: pink">${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}else{
									var trElement = `
									<tr class="table-light">
										<td><span class="h6 fw-bold text-uppercase">Итого Доходов</span></td>
										<td>${priceSet(res[key][values].plan)}</td>
										<td>${priceSet(res[key][values].fact)}</td>
										<td>${priceSet(res[key][values].raznica)}</td>
										<td>${res[key][values].proc}</td>
									</tr>`;
									$('.information_result').append(trElement);
								}
							}
						}
					}else if(key == 'diff'){
						var trElement = `
						<tr class="table-info">
							<th><span class="h6 fw-bold text-uppercase">РАЗНИЦА ДОХ-РАСХ</span></th>
							<th>${priceSet(res[key].plan)}</th>
							<th>${priceSet(res[key].fact)}</th>
							<th>${priceSet(res[key].raznica)}</th>
							<th></th>
						</tr>`
						$('.information_result').append(trElement);
					}
				}
			}).catch(function(err){
				var x = 0;
			})
		})

	</script>

{% endblock content %}