{% extends 'mainapp/base.html' %}
{% load static %}
{% block content %}

	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="card-header d-flex align-items-center card-header-no-bg border-bottom-0">
						{% if user.is_superuser or user.is_staff %}
						<div class="card-options ms-auto">
							<a href="{% url 'holder_create' %}" class="btn btn-primary btn-sm">Добавить</a>
						</div>
						{% endif %}
					</div>
					<div class="table-responsive">
						{% if holders %}
						<div class="card-body">
							<div class="table-responsive">
								<table class="table table-bordered text-nowrap mb-0">
									<thead class="text-center">
										<tr>
											<th>Наименование</th>
											<th>Баланс Держателя</th>
											<th>Реквезиты</th>
											<th>Псевдоним реквезита</th>
										</tr>
									</thead>
									<tbody class="text-center">
										{% for object in holders %}
											<tr class="align-middle">
												<td>
													<div class="d-flex justify-content-between">
														<div class="d-flex justify-content-start" >
															<span data-bs-toggle="tooltip" data-bs-trigger="hover" title="Скрыть транзакции балансодержателя" >
																<input class="form-check-input" type="checkbox" name="{{ object.id }}" data-holder-name="{{ object.organization_holder }}"
																{% if request.user in object.hide_for_me %} checked{% endif %}/>
														   </span>
															
														</div>
														<div class="d-flex justify-content-start">
														{{ object.organization_holder }}
															{% if object.hidden_status %}
																<span data-bs-toggle="tooltip" data-bs-title="Имеют доступ: {% for obj in object.available_users %} {{ obj }} {% endfor %}">
																	 &emsp; <i class="fa-regular fa-info"></i>  <i>Невидимый</i>
																</span>
															{% endif %}
														</div>
													{% if user.is_superuser %}
														<div class="d-flex justify-content-end">
															<a href="{% url 'holder_update' object.id %}" class="btn btn-light btn-sm" data-bs-toggle="tooltip" data-bs-title="Редактировать">
																<i class="fa-regular fa-pen-to-square"></i>
															</a>
														</div>
													{% endif %}
													</div>
												</td>
												<td>{{ object.holder_balance|numb_format }}</td>
												<td>{{ object.payment_account|for_card_step }}</td>
												<td>{{ object.alias_holder }}</td>
											</tr>
										{% endfor %}
									</tbody>
								</table> <!-- /table -->
							</div> <!-- /table-responsive -->
						</div>
						{% else %}
						<div class="alert alert-warning" role="alert">
							<h5 class="alert-heading text-center">
								<i class="fa-regular fa-octagon-exclamation me-2"></i>
								Нет доступных данных
							</h5>
						</div>
						{% endif %}
					</div> <!-- /table-responsive -->
				</div> <!-- /card-body -->
			</div> <!-- /card -->
		</div> <!-- /col -->
	</div> <!--/row-->

	<div class="position-fixed bottom-0 top-5 end-0 p-3" style="z-index: 11">
		<div id="liveToast" class="toast hide bg-primary" role="alert" aria-live="assertive" aria-atomic="true">
			 <div class="toast-header">
				<button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Закрыть"></button>
			  </div>
			<div class="toast-body text-white" id="toast_content">
				
			</div>
		</div>
	</div>

<script>
	var url = document.location.href;
	var a = document.cookie.split(';');
	var token = '';

	for (i = 0; i < a.length; i++) {
		var b = a[i].split('=');
		b[0] = b[0].replace(/\s+/g, '');
		if (b[0] == 'csrftoken') {
			token = b[1]
		}
	};
	
	inputEl = document.querySelectorAll('.form-check-input')
	for (let i=0; i<inputEl.length; i++){
		inputEl[i].addEventListener('click', function(event){
			if(event.currentTarget == inputEl[i]){
				if (inputEl[i].checked){
					$.ajax({
						url: url,
						method: 'POST',
						data: {
							csrfmiddlewaretoken: token,
							type: 'hide_for_me',
							holder_id: inputEl[i].name
						}
					}).then(function(result){
						var toastElList = [].slice.call(document.querySelectorAll('.toast'))
						var toastList = toastElList.map(function(toastEl) {
							$('#toast_content').text(`Скрыты транзакции ${inputEl[i].getAttribute('data-holder-name')}`);
							// Creates an array of toasts (it only initializes them)
							return new bootstrap.Toast(toastEl) // No need for options; use the default options
						});
						toastList.forEach(toast => toast.show()); // This show them
					}).catch(function(err){
						var x = 0;
					});
				}else{
					$.ajax({
						url: url,
						method: 'POST',
						data: {
							csrfmiddlewaretoken: token,
							type: 'show_for_me',
							holder_id: inputEl[i].name
						}
					}).then(function(result){
						var toastElList = [].slice.call(document.querySelectorAll('.toast'))
						var toastList = toastElList.map(function(toastEl) {
							$('#toast_content').text(`Доступны транзакции ${inputEl[i].getAttribute('data-holder-name')}`);
							// Creates an array of toasts (it only initializes them)
							return new bootstrap.Toast(toastEl) // No need for options; use the default options
						});
						toastList.forEach(toast => toast.show()); // This show them
					}).catch(function(err){
						var x = 0;
					});
				}
			}
		})
	};

</script>

{% endblock content %}
