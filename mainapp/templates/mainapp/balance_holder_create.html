{% extends 'mainapp/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}

	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div>
						<form method="POST" action="">
							{% csrf_token %}

							<div class="row">

								<div class="col-12 col-sm-3 mb-3">
									<label for="holder_type">Тип балансодержателя</label>
									<select autocomplete="off" class="obligatory form-select" name="holder_type" id="holder_type">
										<option selected value="">Выберите тип балансодержателя</option>
										<option value="PRIVATE_PERSONE">Физ. лицо</option>
										<option value="ORGANISATION">Юр. лицо</option>
									</select>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									<label id="label_organisation" for="organization_holder">Наименование организации</label>
									<input autocomplete="off" class="obligatory form-control" name="organization_holder" id="organization_holder" placeholder="ООО &quot;Наименование&quot;"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									<label for="account_type">Реквезиты</label>
									<select autocomplete="off" class="obligatory form-select" name="account_type" id="account_type">
										<option selected value="">Выберите тип</option>
										<option value="CARD">Номер карты</option>
										<option value="SCORE">Номер счета</option>
									</select>
								</div>

								<div class="col-12 col-sm-3 mb-3 payment_account_div" hidden>
									<label id="label_payment_account" for="payment_account">Расчетный счет</label>
									<input autocomplete="off" class="obligatory form-control" name="payment_account" id="payment_account" placeholder="********************"/>
								</div>

								<div class="col-12 col-sm-3 mb-3 alias_holder_div" hidden>
									<label for="alias_holder">Псевдоним реквезита</label>
									<input autocomplete="off" class="obligatory form-control" name="alias_holder" id="alias_holder" placeholder="Tinkoff"/>
								</div>

							</div>

							<div id="accordionStatsDaysFilter">
								<div id="collapseStatsDaysFilter-1" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionStatsDaysFilter" style="">

									<div class="row">

										<div class="col-12 col-sm-3 mb-3">
											<label for="holder_balance">Баланс Держателя</label>
											<input autocomplete="off" class="form-control" name="holder_balance" id="holder_balance" placeholder="По дефолту 0"/>
										</div>

									</div>

								</div>
							</div>

							<div class="row">

								<div class="col-sm-3 mb-3">

									<button class="btn btn-primary create_holder" type="submit">
										Сохранить
									</button> <!-- /btn -->

									<button class="btn btn-secondary collapsed" onclick="$(this).text($(this).text() == 'Скрыть' ? 'Раскрыть' : 'Скрыть');" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStatsDaysFilter-1" aria-expanded="false" aria-controls="collapseStatsDaysFilter-1">
										Раскрыть
									</button>

								</div>

							</div>
						</form>
					</div> <!-- /table-responsive -->
				</div> <!-- /card-body -->
			</div> <!-- /card -->
		</div> <!-- /col -->
	</div> <!--/row-->
	
<script type="text/javascript">

	var url = document.location.href;
	var a = document.cookie.split(';');
	var token = ''

	for (i = 0; i < a.length; i++) {
		var b = a[i].split('=')
		b[0] = b[0].replace(/\s+/g, '')
		if (b[0] == 'csrftoken') {
		token = b[1]
		}
	}

	document.querySelector('#payment_account').addEventListener('input', function(){
		const len = this.value.replace(/\s+/g, '').length
		if((len) % 4 == 0){
			if (this.value.slice(-1) != ' '){
				this.value+=' '
			}else{
				this.value+=''
			}
		}
	})

	var regEx = /[\\><\|\/a-zA-Z\/\+~\=`\]!\[@\{#\}$%\^&:;*\?\(\)_\-а-яА-Я]/;

	$('#holder_balance').on('input change', function(){
		if($('#holder_balance').val()){
			if (regEx.test($('#holder_balance').val())){
				$('#holder_balance').addClass('is-invalid')
			}else{
				$('#holder_balance').removeClass('is-invalid')
			}
		}else{
			$('#holder_balance').removeClass('is-invalid')
		}
	})

	$('#payment_account').on('input change', function(){
		var paccount = $('#payment_account').val().replace(/\s+/g, '')
		if (paccount){
			if (regEx.test(paccount) || ((paccount.length > 20)) || ((paccount.length < 16))){
				$('#payment_account').addClass('is-invalid');
				$('#payment_account').removeClass('is-valid');
			}else{
				$('#payment_account').removeClass('is-invalid');
				$('#payment_account').addClass('is-valid');
			}
		}
	})

	$('#organization_holder').on('input', function(){
		$(".error").remove();
		$.ajax(
			{
				url: url,
				method: 'POST',
				data: {
					csrfmiddlewaretoken: token,
					type: 'check_holder',
					organization_holder: $('#organization_holder').val()
				}
			}).then(function(result) {
				if (result.message) {
					$('#organization_holder').removeClass('is-invalid');
					$('#organization_holder').addClass('is-valid');
				} else {
					$('#organization_holder').removeClass('is-valid');
					$('#organization_holder').addClass('is-invalid');
					$('#organization_holder').after('<div class="invalid-feedback error">Такой балансодержатель уже зарегестрирован</div>')
				}
				if (!$('#organization_holder').val()){
					$('#organization_holder').removeClass('is-valid');
					$('#organization_holder').addClass('is-invalid');
				}
			}).catch(function(err) {
				var x = 1;
			}
		)
	})

	$('#holder_type').on('change', function(){
		if($('#holder_type').val()){
			$('#holder_type').removeClass('is-invalid')
			if ($('#holder_type').val() == "PRIVATE_PERSONE"){
				$('#label_organisation').text('ФИО держателя')
				$('#organization_holder').attr('placeholder', 'Иванов Иван Иванович')
			}else if ($('#holder_type').val() == "ORGANISATION"){
				$('#label_organisation').text('Наименование организации')
				$('#organization_holder').attr('placeholder', 'OOO "Наименование"')
			}
		}else{
			$('#holder_type').addClass('is-invalid')
		}
	})

	$('#account_type').on('change', function(){
		if($('#account_type').val()){
			$('.payment_account_div').removeAttr('hidden')
			$('.alias_holder_div').removeAttr('hidden')
			$('#account_type').removeClass('is-invalid')
			if ($('#account_type').val() == "CARD"){
				$('#label_payment_account').text('Номер карты')
				$('#payment_account').attr('placeholder', '**** **** **** ****')
			}else if ($('#account_type').val() == "SCORE"){
				$('#label_payment_account').text('Номер расчетного счета')
				$('#payment_account').attr('placeholder', '**** **** **** **** ****')
			}
		}else{
			$('#holder_type').addClass('is-invalid')
		}
	})

	// $('form').on('change keyup input click focusot live', function(){
		
	// 	var valid = []

	// 	var obj = $('.obligatory');

	// 	for(let i = 0; i<obj.length; i++){
	// 		if(!obj[i].value){
	// 			$('.create_holder').attr('disabled', 'true');
	// 			valid.append(1)
	// 		}else if (obj[i].classList.contains('is-invalid')){
	// 			$('.create_holder').attr('disabled', 'true');
	// 			valid.append(1)
	// 		}
	// 	}
	// 	if (valid.length>1){
	// 		$('.create_holder').removeAttr('disabled')
	// 	}
	// })

	$(document).ready(function() {
		$('form').submit(function(e) {
			e.preventDefault();
			var valid = true;

			var payment_account = $('#payment_account').val().replace(/\s+/g, '');
			var holder_balance = $('#holder_balance').val();
			var validPayment_account = regEx.test(payment_account);
			var validHolder_balance = regEx.test(holder_balance);
			$(".error").remove();

			if(!$('#organization_holder').val()){
				$('#organization_holder').addClass('is-invalid');
				$('#organization_holder').after('<div class="invalid-feedback error">Заполните поле</div>');
				valid = false;
			}

			if($('#organization_holder').hasClass('is-invalid')){
				valid = false;
			}

			if(!$('#holder_type').val()){
				$('#holder_type').addClass('is-invalid');
				valid = false;
			}

			if(!$('#account_type').val()){
				$('#account_type').addClass('is-invalid');
				valid = false;
			}

			if (validPayment_account || ((payment_account.length > 20)) || ((payment_account.length < 16))){
				$('#payment_account').addClass('is-invalid');
				$('#payment_account').after('<span class="error">Введите корректные данные</span>');
				valid = false;
			}

			if (validHolder_balance) {
				$('#validHolder_balance').addClass('is-invalid');
				$('#validHolder_balance').after('<span class="error">Введите корректные данные</span>');
				valid = false;
			}
			if (valid){
				this.submit();
				$('.create_holder').removeAttr('disabled')
			} 
		});
	});

</script>

{% endblock content %}
