{% extends 'mainapp/base.html' %}
{% load static %}
{% load crispy_forms_tags %}
{% block content %}

	<div class="row mb-4">
		<div class="col-12">
			<div class="card">
				<div class="card-body">
					<div class="card-body">
						<form method="POST"  action="" enctype="multipart/form-data">
							{% csrf_token %}

							<div class="row">

								<div class="col-12 col-sm-3 mb-3">
									{{ form.balance_holder.label }}
									<input class="obligatory form-control" name="balance_holder" id="balance_holder" value="{{ holder_pk }}" disabled/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
								  {{ form.name.label }}
								  	<input autocomplete="off" onfocus="this.value=''" class="obligatory form-control mb-2 is-invalid" name="transaction_name" id="transaction_name" placeholder="Имя транзакции"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									{{ form.transaction_date.label }}
									<input autocomplete="off" class="obligatory form-control is-invalid" name="transaction_date" placeholder="Нажмите сюда" id="datepicker"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									{{ form.type_payment.label }}
									<input autocomplete="off" onfocus="this.value=''" list="list_pay" class="obligatory form-control is-invalid" name="type_payment" id="type_payment" placeholder="Тип платежа" "/>
									<datalist id="list_pay">
										{% for type in type_payments %}
										<option value="{{ type }}">{{ type }}</option>
										{% endfor %}
									</datalist>
								</div>

								<div class="col-12 col-sm-3 mb-3">
									{{ form.amount.label }}
									<input autocomplete="off" class="obligatory form-control is-invalid" name="amount" placeholder="Сумма транзакции" id="amount"/>
								</div>

								<div class="col-12 col-sm-3 mb-3">
								  {{ form.type_transaction.label }}
									<input autocomplete="off" onfocus="this.value=''" class="obligatory form-control mb-2 is-invalid" name="type_transaction" list="datalist_transaction_type" id="type_transaction" placeholder="Тип транзакции"/>
								  	<datalist id="datalist_transaction_type">
										<option value="Приход">Приход</option>
										<option value="Расход">Расход</option>
									</datalist>
								</div>

							</div>

							<div id="accordionStatsDaysFilter">
								<div id="collapseStatsDaysFilter-1" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionStatsDaysFilter" style="">
									<div class="row">

										<div class="col-12 col-sm-3 mb-3">
										  {{ form.status.label }}
											<input autocomplete="off" onfocus="this.value=''" class="obligatory form-control mb-2" name="transaction_status" list="datalistStatus" id="transaction_status" value="В процессе"/>
											<datalist id="datalistStatus">
												<option value="В процессе">В процессе</option>
												<option value="Отклонен">Отклонен</option>
												<option value="Успешно">Успешно</option>
											</datalist>
										</div>

										<div class="col-12 col-sm-3 mb-3">
											{{ form.check_img.label }}
											<input class="form-control mb-2 fileinput fileUpload form-control-file" name="check_img" type="file" id="id_check_img">
										</div>

										<div class="col-12 col-sm-3 mb-3">
											{{ form.description.label }}
											{{ form.description }}
										</div>

										<div class="col-12 col-sm-3 mb-3">
											{{ form.tags.label }}
											{{ form.tags }}
										</div>

									</div>
								</div>
							</div>

							<div class="row">
								<div class="col-sm-3 mb-3">

									<button class="btn btn-primary" type="submit" disabled>
										Сохранить
									</button> <!-- /btn -->

									<button onclick="$(this).text($(this).text() == 'Скрыть' ? 'Раскрыть' : 'Скрыть');" type="button" class="btn btn-secondary text-white collapsed" data-bs-toggle="collapse" data-bs-target="#collapseStatsDaysFilter-1" aria-expanded="false" aria-controls="collapseStatsDaysFilter-1">
										Раскрыть
									</button>

								</div>
							</div>

						</form> <!-- /form-body -->
					</div> <!-- /card-body -->
				</div> <!-- /card-body -->
			</div> <!-- /card -->
		</div> <!-- /col -->
	</div> <!--/row-->

<script type="text/javascript">
	$(function(){
		$("#datepicker").datepicker({dateFormat: 'dd.mm.yy'});
	});
</script>

<script type="text/javascript">

	$('form').on('change keyup input click focusot live', function(){

		var objects = $('.obligatory')

		for (let i=0; objects.length > i; i++){
			if (objects[i].value){
				objects[i].classList.remove('is-invalid')
			}else{
				objects[i].classList.add('is-invalid')
			}
		}
		
		if ($('#amount').val())

		// if ($('#transaction_status').val() == 'Успешно'){
		// 	if (!$('#id_check_img').val()){
		// 		$('#id_check_img').addClass('is-invalid')
		// 	}else{
		// 		$('#id_check_img').removeClass('is-invalid')
		// 	}
		// }else{
		// 	$('#id_check_img').removeClass('is-invalid')
		// }

		if ($('#balance_holder').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else if ($('#transaction_name').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else if ($('#transaction_status').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else if ($('#datepicker').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else if ($('#type_payment').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else if ($('#amount').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else if ($('#type_transaction').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else if ($('#id_check_img').hasClass('is-invalid')){
			$('button').attr('disabled', 'true');
		}else{
			$('button').removeAttr('disabled');
		}
	})

	$('#datepicker').on('change click focusot hover', function(){
		if ($('#datepicker').val()){
			$('#datepicker').removeClass('is-invalid')
		}else{
			$('#datepicker').addClass('is-invalid')
		}
	})

	$(document).ready(function() {
		$('form').submit(function(e) {
			e.preventDefault();
			var valid = true;
			var regEx = /[\\><\|\/a-zA-Z\/\+~\=`\]!\[@\{#\}$%\^&:;*\?\(\)_\-а-яА-Я]/;

			var amount = $('#amount').val();
			var dateEl = $('#datepicker').val();

			var validDate = regEx.test(dateEl);
			var validAmount = regEx.test(amount);

			$(".error").remove();
			
			if (validDate || (dateEl.length != 10)){
				$('#datepicker').addClass('is-invalid');
				$('#datepicker').after('<span class="error">Введите корректные данные</span>');
				valid = false;
			}
			
			if (validAmount) {
				$('#amount').addClass('is-invalid');
				$('#amount').after('<span class="error">Введите корректные данные</span>');
				valid = false;
			}
			if (valid) this.submit();
		});
	});

</script>

{% endblock content %}